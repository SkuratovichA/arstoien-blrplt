# =============================================================================
# PR Preview Deployment Workflow
# =============================================================================
# Deploys a preview environment when the 'deploy' label is added to a PR
# Tears down the environment when the PR is closed

name: Deploy Preview

on:
  pull_request:
    types: [labeled, unlabeled, closed, synchronize]

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: false

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '9.14.2'
  AWS_REGION: us-east-1
  ECR_REPOSITORY: blrplt-production-server
  ECS_CLUSTER: blrplt-production-cluster
  PREVIEW_PREFIX: blrplt-pr-${{ github.event.pull_request.number }}

jobs:
  # ===========================================================================
  # Check if deployment should run
  # ===========================================================================
  check-label:
    name: Check Deploy Label
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      should_destroy: ${{ steps.check.outputs.should_destroy }}
    steps:
      - name: Check conditions
        id: check
        run: |
          # Check if PR has 'deploy' label
          HAS_LABEL="${{ contains(github.event.pull_request.labels.*.name, 'deploy') }}"
          IS_CLOSED="${{ github.event.action == 'closed' }}"
          IS_UNLABELED="${{ github.event.action == 'unlabeled' && github.event.label.name == 'deploy' }}"

          echo "has_label=$HAS_LABEL"
          echo "is_closed=$IS_CLOSED"
          echo "is_unlabeled=$IS_UNLABELED"

          if [[ "$IS_CLOSED" == "true" ]] || [[ "$IS_UNLABELED" == "true" ]]; then
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "should_destroy=true" >> $GITHUB_OUTPUT
          elif [[ "$HAS_LABEL" == "true" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "should_destroy=false" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "should_destroy=false" >> $GITHUB_OUTPUT
          fi

  # ===========================================================================
  # Wait for CI to pass before deploying
  # ===========================================================================
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    needs: check-label
    if: needs.check-label.outputs.should_deploy == 'true'
    steps:
      - name: Wait for CI workflow
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'CI Success'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success

  # ===========================================================================
  # Build and Push Server Image
  # ===========================================================================
  build-server:
    name: Build Server Image
    runs-on: ubuntu-latest
    needs: wait-for-ci
    outputs:
      image: ${{ steps.build.outputs.image }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push server image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: packages/server/Dockerfile
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image
        run: echo "image=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Deploy Preview Infrastructure
  # ===========================================================================
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: build-server
    outputs:
      client_url: ${{ steps.terraform.outputs.client_url }}
      admin_url: ${{ steps.terraform.outputs.admin_url }}
      client_bucket: ${{ steps.terraform.outputs.client_bucket }}
      admin_bucket: ${{ steps.terraform.outputs.admin_bucket }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/preview
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
            -backend-config="key=blrplt/preview/${{ github.event.pull_request.number }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true"

      - name: Terraform Apply
        id: terraform
        working-directory: infrastructure/terraform/environments/preview
        run: |
          terraform apply -auto-approve \
            -var="pr_number=${{ github.event.pull_request.number }}" \
            -var="ecs_cluster_arn=${{ secrets.ECS_CLUSTER_ARN }}" \
            -var="ecs_execution_role_arn=${{ secrets.ECS_EXECUTION_ROLE_ARN }}" \
            -var="ecs_task_role_arn=${{ secrets.ECS_TASK_ROLE_ARN }}" \
            -var="database_url=${{ secrets.PREVIEW_DATABASE_URL }}" \
            -var="redis_url=${{ secrets.PREVIEW_REDIS_URL }}" \
            -var="jwt_secret=${{ secrets.JWT_SECRET }}" \
            -var="jwt_refresh_secret=${{ secrets.JWT_REFRESH_SECRET }}"

          echo "client_url=$(terraform output -raw client_url)" >> $GITHUB_OUTPUT
          echo "admin_url=$(terraform output -raw admin_url)" >> $GITHUB_OUTPUT
          echo "client_bucket=$(terraform output -raw client_bucket)" >> $GITHUB_OUTPUT
          echo "admin_bucket=$(terraform output -raw admin_bucket)" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Deploy Static Files
  # ===========================================================================
  deploy-static:
    name: Deploy Static Files
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build client
        run: pnpm --filter @blrplt/client build
        env:
          VITE_API_URL: http://${{ env.PREVIEW_PREFIX }}-server.preview.local:4000
          VITE_WS_URL: ws://${{ env.PREVIEW_PREFIX }}-server.preview.local:4000
          VITE_APP_NAME: "Preview PR-${{ github.event.pull_request.number }}"

      - name: Build admin
        run: pnpm --filter @blrplt/admin build
        env:
          VITE_API_URL: http://${{ env.PREVIEW_PREFIX }}-server.preview.local:4000
          VITE_GRAPHQL_URL: http://${{ env.PREVIEW_PREFIX }}-server.preview.local:4000/graphql

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy client to S3
        run: |
          aws s3 sync packages/client/dist s3://${{ needs.deploy-infrastructure.outputs.client_bucket }} --delete

      - name: Deploy admin to S3
        run: |
          aws s3 sync packages/admin/dist s3://${{ needs.deploy-infrastructure.outputs.admin_bucket }} --delete

  # ===========================================================================
  # Comment on PR with preview URLs
  # ===========================================================================
  comment-preview:
    name: Comment Preview URLs
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-static]
    steps:
      - name: Find existing comment
        id: find-comment
        uses: peter-evans/find-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## Preview Environment'

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## Preview Environment üöÄ

            Your preview environment is ready!

            | Component | URL |
            |-----------|-----|
            | Client | ${{ needs.deploy-infrastructure.outputs.client_url }} |
            | Admin | ${{ needs.deploy-infrastructure.outputs.admin_url }} |

            ---

            **Commit:** `${{ github.event.pull_request.head.sha }}`
            **Last Updated:** ${{ github.event.pull_request.updated_at }}

            > ‚ö†Ô∏è This environment will be automatically destroyed when the PR is closed or the `deploy` label is removed.

  # ===========================================================================
  # Destroy Preview Environment
  # ===========================================================================
  destroy:
    name: Destroy Preview
    runs-on: ubuntu-latest
    needs: check-label
    if: needs.check-label.outputs.should_destroy == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/preview
        continue-on-error: true
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
            -backend-config="key=blrplt/preview/${{ github.event.pull_request.number }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true"

      - name: Empty S3 buckets
        continue-on-error: true
        run: |
          aws s3 rm s3://${{ env.PREVIEW_PREFIX }}-client --recursive || true
          aws s3 rm s3://${{ env.PREVIEW_PREFIX }}-admin --recursive || true

      - name: Terraform Destroy
        working-directory: infrastructure/terraform/environments/preview
        continue-on-error: true
        run: |
          terraform destroy -auto-approve \
            -var="pr_number=${{ github.event.pull_request.number }}" \
            -var="ecs_cluster_arn=${{ secrets.ECS_CLUSTER_ARN }}" \
            -var="ecs_execution_role_arn=${{ secrets.ECS_EXECUTION_ROLE_ARN }}" \
            -var="ecs_task_role_arn=${{ secrets.ECS_TASK_ROLE_ARN }}" \
            -var="database_url=dummy" \
            -var="redis_url=dummy" \
            -var="jwt_secret=dummy" \
            -var="jwt_refresh_secret=dummy" || true

      - name: Comment destruction
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Preview Environment Destroyed üóëÔ∏è

            The preview environment has been successfully torn down.
