name: Deploy to AWS App Runner

on:
  push:
    branches: [main]
  pull_request:
    types: [labeled]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - development

env:
  AWS_REGION: eu-central-1

permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required for actions/checkout

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      ecr_repository: ${{ steps.set-env.outputs.ecr_repository }}
      should_deploy: ${{ steps.set-env.outputs.should_deploy }}
    steps:
      - id: set-env
        run: |
          # Default to not deploying
          echo "should_deploy=false" >> $GITHUB_OUTPUT

          # Check trigger conditions
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "ecr_repository=blrplt-server" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ contains(github.event.label.name, 'dev-deploy') }}" == "true" ]]; then
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "ecr_repository=blrplt-server-dev" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            if [[ "${{ inputs.environment }}" == "production" ]]; then
              echo "ecr_repository=blrplt-server" >> $GITHUB_OUTPUT
            else
              echo "ecr_repository=blrplt-server-dev" >> $GITHUB_OUTPUT
            fi
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

  deploy-server:
    name: Deploy Server to App Runner (${{ needs.determine-environment.outputs.environment }})
    runs-on: ubuntu-latest
    needs: determine-environment
    if: needs.determine-environment.outputs.should_deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push server image to ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ needs.determine-environment.outputs.ecr_repository }}
          IMAGE_TAG: ${{ github.sha }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Build Docker image for server (from monorepo root)
          docker build -f packages/server/Dockerfile \
            --build-arg NPM_TOKEN=$NPM_TOKEN \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest

          # Push both tags to ECR
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Deploy to App Runner
        env:
          ENVIRONMENT: ${{ needs.determine-environment.outputs.environment }}
        run: |
          # Get the App Runner service ARN based on environment
          if [[ "$ENVIRONMENT" == "production" ]]; then
            SERVICE_NAME="blrplt-server"
          else
            SERVICE_NAME="blrplt-server-dev"
          fi

          SERVICE_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='$SERVICE_NAME'].ServiceArn" --output text)

          if [ -z "$SERVICE_ARN" ]; then
            echo "Error: App Runner service 'blrplt-server' not found"
            exit 1
          fi

          # Start deployment with the new image
          aws apprunner start-deployment --service-arn $SERVICE_ARN

          echo "Deployment started for App Runner service"

          # Wait for deployment to complete (optional)
          echo "Waiting for deployment to complete..."
          aws apprunner wait service-updated --service-arn $SERVICE_ARN

          echo "Deployment completed successfully!"

  deploy-client:
    name: Deploy Client to S3/CloudFront
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies and build client
        run: |
          cd client
          yarn install --frozen-lockfile
          yarn build

      - name: Deploy client to S3
        run: |
          aws s3 sync client/dist s3://blrplt-client-production --delete

      - name: Invalidate CloudFront cache
        run: |
          # Get CloudFront distribution ID
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Origins.Items[?DomainName=='blrplt-client-production.s3.amazonaws.com']].Id" \
            --output text)

          if [ ! -z "$DISTRIBUTION_ID" ]; then
            aws cloudfront create-invalidation \
              --distribution-id $DISTRIBUTION_ID \
              --paths "/*"
            echo "CloudFront cache invalidated"
          fi

  deploy-admin:
    name: Deploy Admin to S3/CloudFront
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies and build admin
        run: |
          cd admin
          yarn install --frozen-lockfile
          yarn build

      - name: Deploy admin to S3
        run: |
          aws s3 sync admin/dist s3://blrplt-admin-production --delete

      - name: Invalidate CloudFront cache
        run: |
          # Get CloudFront distribution ID
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Origins.Items[?DomainName=='blrplt-admin-production.s3.amazonaws.com']].Id" \
            --output text)

          if [ ! -z "$DISTRIBUTION_ID" ]; then
            aws cloudfront create-invalidation \
              --distribution-id $DISTRIBUTION_ID \
              --paths "/*"
            echo "CloudFront cache invalidated"
          fi